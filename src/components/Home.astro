---
import type { CollectionEntry } from 'astro:content';
interface Props {
  posts: CollectionEntry<'blog'>[];
}
const { posts } = Astro.props as Props;
const pinnedPosts = posts
  .filter(post => post.data.pinned)
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());
const regularPosts = posts
  .filter(post => !post.data.pinned)
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());

const workingOn = [
  'tinygrad bounties',
  'learning rdna',
  'educational resources',
  'compilers / ml',
];

const latestPostDate = posts.reduce((latest, post) => {
  const date = new Date(post.data.pubDate);
  return date > latest ? date : latest;
}, new Date(0));
const latestPostLabel = latestPostDate.getTime() ? latestPostDate.toISOString().slice(0, 10) : '—';

// Category mapping: consolidate similar categories
const catMap: Record<string, string> = {
  'programming': 'code',
  'machine learning': 'code',
  'biology': 'bio',
  'misc': 'tech',
};
const mapCat = (cat?: string) => cat ? (catMap[cat] || cat) : '—';

// Category colors
const catColors: Record<string, string> = {
  'code': '#6ee7b7',     // mint green
  'bio': '#a78bfa',      // soft purple
  'tech': '#fbbf24',     // amber
  'hardware': '#f472b6', // pink
};
const getCatColor = (cat: string) => catColors[cat] || '#666';

// Get unique mapped categories
const categories = [...new Set(regularPosts.map(p => mapCat(p.data.cat)).filter(c => c !== '—'))];
---

<section class="brutalist-home">
  <div class="masthead">
    <div class="title-block">
      <h1 class="site-name">ANURAAG</h1>
      <div class="tagline">systems / ml / gpu</div>
    </div>
    <div class="meta-block">
      <span class="meta-item">{posts.length} posts</span>
      <span class="meta-sep">/</span>
      <span class="meta-item">{categories.length} cats</span>
      <span class="meta-sep">/</span>
      <span class="meta-item">updated {latestPostLabel}</span>
    </div>
  </div>

  <div class="working-strip">
    <span class="working-label">NOW:</span>
    {workingOn.map((item, i) => (
      <span class="working-item">{item}{i < workingOn.length - 1 ? ',' : ''}</span>
    ))}
  </div>

  {pinnedPosts.length > 0 && (
    <div class="pinned-section">
      <div class="section-header">PINNED</div>
      {pinnedPosts.map(post => (
        <a class="pinned-link" href={`/blog/${post.slug}`}>
          {post.data.title}
        </a>
      ))}
    </div>
  )}

  <div class="index-section">
    <div class="section-header">INDEX</div>
    <ol class="post-index">
      {regularPosts.map((post, idx) => (
        <li class="index-item">
          <a href={`/blog/${post.slug}`} class="index-link">
            <span class="index-num">{String(idx + 1).padStart(2, '0')}</span>
            <span class="index-title">{post.data.title}</span>
            <span class="index-meta">
              <span class="index-cat" style={`color: ${getCatColor(mapCat(post.data.cat))}`}>{mapCat(post.data.cat)}</span>
              <span class="index-date">{post.data.pubDate}</span>
            </span>
          </a>
        </li>
      ))}
    </ol>
  </div>

  <div class="footer-art" aria-hidden="true">
    <pre class="ascii-cat" set:html={`  /\\_/\\
 ( o.o )
  &gt; ^ &lt;`} />
  </div>
</section>

<style>
  .brutalist-home {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1rem 4rem;
    font-family: "Google Sans Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  .masthead {
    border: 2px solid #fff;
    padding: 2rem;
    margin-bottom: 1.5rem;
  }

  .title-block {
    margin-bottom: 1.5rem;
  }

  .site-name {
    font-size: clamp(3rem, 12vw, 6rem);
    font-weight: 800;
    margin: 0;
    line-height: 0.9;
    letter-spacing: -0.04em;
    color: #fff;
  }

  .tagline {
    font-size: 1rem;
    color: #888;
    margin-top: 0.5rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  .meta-block {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: #666;
  }

  .meta-sep {
    color: #444;
  }

  .working-strip {
    background: #fff;
    color: #000;
    padding: 0.75rem 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.85rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }

  .working-label {
    font-weight: 700;
    text-transform: uppercase;
  }

  .working-item {
    color: #333;
  }

  .pinned-section {
    border-left: 4px solid var(--accent);
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
  }

  .section-header {
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    color: #666;
    margin-bottom: 1rem;
    text-transform: uppercase;
  }

  .pinned-link {
    display: block;
    color: var(--accent);
    text-decoration: none;
    font-size: 1.1rem;
    font-weight: 600;
    padding: 0.25rem 0;
    transition: color 0.1s;
  }

  .pinned-link:hover {
    color: #fff;
    text-decoration: underline;
    text-underline-offset: 4px;
  }

  .index-section {
    margin-bottom: 3rem;
  }

  .post-index {
    list-style: none;
    padding: 0;
    margin: 0;
    counter-reset: none;
  }

  .index-item {
    border-bottom: 1px solid #333;
  }

  .index-item:first-child {
    border-top: 1px solid #333;
  }

  .index-link {
    display: grid;
    grid-template-columns: 2.5rem 1fr auto;
    gap: 1rem;
    align-items: baseline;
    padding: 1rem 0.5rem;
    text-decoration: none;
    color: inherit;
    transition: background 0.1s;
  }

  .index-link:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .index-num {
    font-size: 0.85rem;
    color: #555;
    font-weight: 600;
  }

  .index-title {
    font-size: 1rem;
    font-weight: 500;
    color: #f4f4f5;
    line-height: 1.3;
  }

  .index-link:hover .index-title {
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .index-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.8rem;
    color: #666;
    white-space: nowrap;
  }

  .index-cat {
    text-transform: lowercase;
    min-width: 6rem;
    text-align: right;
  }

  .index-date {
    color: #777;
    font-variant-numeric: tabular-nums;
  }

  .footer-art {
    text-align: center;
    padding: 2rem;
    opacity: 0.3;
    transition: opacity 0.3s;
  }

  .footer-art:hover {
    opacity: 0.8;
  }

  .ascii-cat {
    font-size: 1rem;
    line-height: 1.2;
    margin: 0;
    color: #fff;
  }

  @media (max-width: 600px) {
    .masthead {
      padding: 1.5rem;
    }

    .site-name {
      font-size: 2.5rem;
    }

    .index-link {
      grid-template-columns: 2rem 1fr;
      grid-template-rows: auto auto;
      gap: 0.25rem 0.75rem;
    }

    .index-num {
      grid-row: 1 / 3;
      align-self: start;
      padding-top: 0.1rem;
    }

    .index-meta {
      grid-column: 2;
      justify-content: flex-start;
      gap: 1rem;
    }

    .index-cat {
      min-width: auto;
      text-align: left;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    * {
      transition: none !important;
    }
  }
</style>
