---
import type { CollectionEntry } from 'astro:content';
interface Props {
  posts: CollectionEntry<'blog'>[];
}
const { posts } = Astro.props as Props;
const pinnedPosts = posts
  .filter(post => post.data.pinned)
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());
const regularPosts = posts
  .filter(post => !post.data.pinned)
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());

const workingOn = [
  'tinygrad bounties',
  'learning rdna',
  'educational resources',
  'compilers / ml',
];

const formatLongDate = (date: Date) => date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).toLowerCase();
const formatPostDate = (dateString: string) => {
  const date = new Date(`${dateString}T00:00:00.000Z`);
  return Number.isNaN(date.getTime()) ? dateString : formatLongDate(date);
};

const latestPostDate = posts.reduce((latest, post) => {
  const date = new Date(post.data.pubDate);
  return date > latest ? date : latest;
}, new Date(0));
const latestPostLabel = latestPostDate.getTime() ? formatLongDate(latestPostDate) : '—';

// Category colors
const catColors: Record<string, string> = {
  'code': '#6ee7b7',     // mint green
  'bio': '#a78bfa',      // soft purple
  'tech': '#fbbf24',     // amber
  'hardware': '#f472b6', // pink
};
const getCatColor = (cat: string) => catColors[cat] || '#666';

// Get unique mapped categories
const categories = [...new Set(regularPosts.map(p => p.data.cat ?? '—').filter(c => c !== '—'))];
---

<section class="brutalist-home">
  <div class="masthead">
    <div class="github-graph">
      <img
        src="https://ghchart.rshah.org/4fd1ff/boopdotpng"
        alt="GitHub contribution graph"
        loading="lazy"
      />
    </div>
    <div class="meta-block">
      <span class="meta-item">{posts.length} posts</span>
      <span class="meta-sep">/</span>
      <span class="meta-item">{categories.length} categories</span>
      <span class="meta-sep">/</span>
      <span class="meta-item">updated {latestPostLabel}</span>
    </div>
  </div>

  <div class="working-strip">
    <span class="working-label">NOW:</span>
    {workingOn.map((item, i) => (
      <span class="working-item">{item}{i < workingOn.length - 1 ? ',' : ''}</span>
    ))}
  </div>

  {pinnedPosts.length > 0 && (
    <div class="pinned-section">
      <div class="section-header">PINNED</div>
      <div class="pinned-grid">
        {pinnedPosts.map((post, idx) => (
          <a class="pinned-card" href={`/blog/${post.slug}`}>
            <span class="pinned-title">{post.data.title}</span>
          </a>
        ))}
      </div>
    </div>
  )}

  <div class="index-section">
    <div class="section-header">INDEX</div>
    <ol class="post-index">
      {regularPosts.map((post, idx) => {
        const indexNum = String(regularPosts.length - idx).padStart(2, '0');
        const catLabel = post.data.cat ?? '—';

        return (
          <li class="index-item">
            <a href={`/blog/${post.slug}`} class="index-link">
              <span class="index-num">{indexNum}</span>
              <span class="index-title">{post.data.title}</span>
              <span class="index-meta">
                <span class="index-cat" style={`color: ${getCatColor(catLabel)}`}>{catLabel}</span>
                <span class="index-date">{formatPostDate(post.data.pubDate)}</span>
              </span>
            </a>
          </li>
        );
      })}
    </ol>
  </div>

  <div class="footer-art" aria-hidden="true">
    <pre class="ascii-cat" set:html={`  /\\_/\\
 ( o.o )
  &gt; ^ &lt;`} />
  </div>
</section>

<style>
  .brutalist-home {
    max-width: 800px;
    margin: 0 auto;
    padding: 1rem 1rem 4rem;
    font-family: "Google Sans Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  .masthead {
    border: 2px solid #fff;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .github-graph {
    margin-bottom: 1rem;
    overflow-x: auto;
  }

  .github-graph img {
    width: 100%;
    height: auto;
    display: block;
    filter: invert(1) hue-rotate(180deg) brightness(1.3);
  }

  .meta-block {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: #666;
  }

  .meta-sep {
    color: #444;
  }

  .working-strip {
    background: rgba(20, 20, 20, 0.9);
    color: #e5e5e5;
    padding: 0.75rem 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.85rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
    border: 1px solid #2a2a2a;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.02) inset;
  }

  .working-label {
    font-weight: 700;
    text-transform: uppercase;
  }

  .working-item {
    color: #b5b5b5;
  }

  .pinned-section {
    border: 1px solid #2a2a2a;
    background: linear-gradient(140deg, rgba(var(--accent-rgb), 0.1), rgba(255, 255, 255, 0.02));
    padding: 1rem 1.25rem;
    margin-bottom: 2rem;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.03) inset;
  }

  .section-header {
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    color: #666;
    margin-bottom: 1rem;
    text-transform: uppercase;
  }

  .pinned-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(2, auto);
    gap: 0.75rem;
  }

  @media (max-width: 600px) {
    .pinned-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .pinned-card {
    position: relative;
    display: block;
    padding: 0.75rem 1rem;
    border: 1px solid #333;
    background: rgba(10, 10, 10, 0.6);
    color: inherit;
    text-decoration: none;
    transition: transform 0.15s, border-color 0.15s, box-shadow 0.15s;
  }

  .pinned-card::before {
    content: "";
    position: absolute;
    inset: 0.35rem;
    border: 1px dashed rgba(255, 255, 255, 0.12);
    pointer-events: none;
  }

  .pinned-card:hover {
    transform: translateY(-2px);
    border-color: #555;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
  }

  .pinned-title {
    font-size: 1rem;
    font-weight: 600;
    color: #f4f4f5;
  }


  .index-section {
    margin-bottom: 3rem;
  }

  .post-index {
    list-style: none;
    padding: 0;
    margin: 0;
    counter-reset: none;
  }

  .index-item {
    border-bottom: 1px solid #333;
  }

  .index-item:first-child {
    border-top: 1px solid #333;
  }

  .index-link {
    display: grid;
    grid-template-columns: 2.5rem 1fr auto;
    gap: 1rem;
    align-items: baseline;
    padding: 1rem 0.5rem;
    text-decoration: none;
    color: inherit;
    transition: background 0.1s;
  }

  .index-link:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .index-num {
    font-size: 0.85rem;
    color: #555;
    font-weight: 600;
  }

  .index-title {
    font-size: 1rem;
    font-weight: 500;
    color: #f4f4f5;
    line-height: 1.3;
  }

  .index-link:hover .index-title {
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .index-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.8rem;
    color: #666;
    white-space: nowrap;
  }

  .index-cat {
    text-transform: lowercase;
    min-width: 6rem;
    text-align: right;
  }

  .index-date {
    color: #777;
    font-variant-numeric: tabular-nums;
  }

  .footer-art {
    text-align: center;
    padding: 2rem;
    opacity: 0.3;
    transition: opacity 0.3s;
  }

  .footer-art:hover {
    opacity: 0.8;
  }

  .ascii-cat {
    font-size: 1rem;
    line-height: 1.2;
    margin: 0;
    color: #fff;
  }

  @media (max-width: 600px) {
    .masthead {
      padding: 1rem;
    }

    .index-link {
      grid-template-columns: 2rem 1fr;
      grid-template-rows: auto auto;
      gap: 0.25rem 0.75rem;
    }

    .index-num {
      grid-row: 1 / 3;
      align-self: start;
      padding-top: 0.1rem;
    }

    .index-meta {
      grid-column: 2;
      justify-content: flex-start;
      gap: 1rem;
    }

    .index-cat {
      min-width: auto;
      text-align: left;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    * {
      transition: none !important;
    }
  }
</style>
